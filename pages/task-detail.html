<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Details - GetItDone</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/styles/styles.css">
</head>
<body>
    <!-- Fiverr-Style Header -->
    <header class="fiverr-header">
        <!-- Top Section -->
        <div class="header-top">
        <div class="container">
                <div class="header-content">
                    <!-- Logo -->
                    <div class="header-logo">
                        <a href="index.html" class="logo-link">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span class="logo-text">GetItDone</span>
                        </a>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="header-search">
                        <div class="search-container">
                            <input type="text" class="search-input" placeholder="What task are you looking for today?" id="header-search-input">
                            <button class="search-button" onclick="performSearch()">
                                <i class="bi bi-search"></i>
            </button>
                        </div>
                    </div>
                    
                    <!-- Right Actions -->
                    <div class="header-actions">
                        <!-- Not Logged In -->
                        <div id="guest-actions">
                            <a href="#" class="action-link" onclick="showLoginModal()">Login</a>
                            <a href="#" class="action-link" onclick="showRegisterModal()">Join</a>
                        </div>
                        
                        <!-- Logged In User -->
                        <div id="user-actions" style="display: none;">
                            <!-- Notifications -->
                            <div class="action-icon position-relative" onclick="showNotifications()">
                                <i class="bi bi-bell"></i>
                                <span class="notification-badge" id="header-notification-badge" style="display: none;">0</span>
                            </div>
                            
                            <!-- Messages -->
                            <div class="action-icon position-relative" onclick="openMessagesModal()">
                                <i class="bi bi-envelope"></i>
                                <span class="notification-badge" id="header-message-badge" style="display: none;">0</span>
                            </div>
                            
                            <!-- Orders/Tasks -->
                            <a href="my-stuff.html" class="action-link">My Tasks</a>
                            <a href="my-stuff.html" class="action-icon mobile-only" title="My Tasks">
                                <i class="bi bi-briefcase"></i>
                            </a>
                            
                            <!-- User Profile -->
                            <div class="user-profile" id="header-user-profile">
                                <div class="profile-avatar-header" onclick="toggleProfileDropdown()">
                                    <span class="profile-initial" id="profile-initial">U</span>
                                    <div class="online-indicator"></div>
                                </div>
                                
                                <!-- Profile Dropdown -->
                                <div class="profile-dropdown" id="profile-dropdown">
                                    <div class="dropdown-header">
                                        <div class="dropdown-user-info">
                                            <div class="dropdown-avatar">
                                                <span class="dropdown-initial" id="dropdown-initial">U</span>
                                            </div>
                                            <div class="dropdown-details">
                                                <div class="dropdown-name" id="dropdown-name">User Name</div>
                                                <div class="dropdown-email" id="dropdown-email">user@email.com</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <a href="account.html" class="dropdown-item">
                                        <i class="bi bi-person-circle"></i>
                                        <span>My Profile</span>
                                    </a>
                                    <a href="my-stuff.html" class="dropdown-item">
                                        <i class="bi bi-briefcase"></i>
                                        <span>My Tasks</span>
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a href="rules.html" class="dropdown-item">
                                        <i class="bi bi-shield-check"></i>
                                        <span>Rules & Safety</span>
                                    </a>
                                    <a href="about.html" class="dropdown-item">
                                        <i class="bi bi-info-circle"></i>
                                        <span>About</span>
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a href="#" class="dropdown-item" onclick="logout()">
                                        <i class="bi bi-box-arrow-right"></i>
                                        <span>Logout</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="browse.html">Browse Tasks</a></li>
                <li class="breadcrumb-item active" aria-current="page">Task Details</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Task Details -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <!-- Task Header -->
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <h1 class="card-title mb-2" id="task-title">Loading...</h1>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="task-pay fs-4" id="task-pay">$0</span>
                                    <span class="status-badge" id="task-status">Open</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-white">Posted by <span id="task-poster" style="cursor: pointer; color: #60a5fa; text-decoration: underline;" onclick="showUserProfileFromTaskDetail()" title="View Profile">Unknown</span></small><br>
                                <small class="text-white" id="task-created">Recently</small>
                            </div>
                        </div>

                        <!-- Task Description -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">Description</h5>
                            <p class="card-text" id="task-description">Loading task description...</p>
                        </div>

                        <!-- Task Details Grid -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-calendar-event text-primary me-3 fs-5"></i>
                                    <div>
                                        <div class="fw-bold">Date</div>
                                        <div class="text-white" id="task-date">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-clock text-primary me-3 fs-5"></i>
                                    <div>
                                        <div class="fw-bold">Time Window</div>
                                        <div class="text-white" id="task-time">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-geo-alt text-primary me-3 fs-5"></i>
                                    <div>
                                        <div class="fw-bold">Location</div>
                                        <div class="text-white" id="task-location">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-person text-primary me-3 fs-5"></i>
                                    <div>
                                        <div class="fw-bold">Contact</div>
                                        <div class="text-white" id="task-contact">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">Categories</h5>
                            <div id="task-tags">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Payment Information Section -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-credit-card me-2"></i>Payment Information
                            </h5>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Total Amount:</span>
                                                <span class="fw-bold">$<span id="task-total-amount">0.00</span></span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Platform Fee (5%):</span>
                                                <span>$<span id="task-platform-fee">0.00</span></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between mb-2 fw-bold">
                                                <span class="text-success">Helper Receives:</span>
                                                <span class="text-success">$<span id="task-helper-payment">0.00</span></span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Payment Method:</span>
                                                <span id="task-payment-method">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Apply Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button class="btn btn-primary btn-lg" id="apply-button" onclick="showApplyModal()">
                                <i class="bi bi-person-plus me-2"></i>Apply to Help
                            </button>
                            <button class="btn btn-success btn-lg" id="completion-button" onclick="markTaskCompleted()" style="display: none;">
                                <i class="bi bi-check-circle me-2"></i>Mark as Completed
                            </button>
                            <a href="browse.html" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>Back to Browse
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Safety Reminder -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="bi bi-shield-check me-2"></i>Safety First
                        </h5>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Meet in public spaces
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Share your location with a friend
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Verify identity before meeting
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Payment after completion
                            </li>
                        </ul>
                        <a href="rules.html" class="btn btn-outline-primary btn-sm mt-3">View Full Safety Guidelines</a>
                    </div>
                </div>

                <!-- Similar Tasks -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Similar Tasks</h5>
                        <div id="similar-tasks">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completion Details Section (for completed tasks) -->
        <div class="row mt-5" id="completion-details-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-check-circle me-2"></i>Task Completion Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold">Completion Information</h6>
                                <p><strong>Completed on:</strong> <span id="completion-date">-</span></p>
                                <p><strong>Completion Notes:</strong> <span id="completion-notes">-</span></p>
                                <p><strong>Payment Status:</strong> <span id="payment-status" class="badge bg-success">Confirmed</span></p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold">Payment Breakdown</h6>
                                <div class="payment-breakdown">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Amount:</span>
                                        <span id="total-amount">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Platform Fee (5%):</span>
                                        <span id="platform-fee">$0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Helper Payment:</span>
                                        <span id="helper-payment">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Payment Method:</span>
                                        <span id="payment-method">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications Section (for task posters) -->
        <div class="row mt-5" id="applications-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-people me-2"></i>Applications
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="applications-container">
                            <!-- Applications will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Modal -->
    <div class="modal fade" id="apply-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Apply to Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="apply-form">
                    <div class="modal-body">
                        <input type="hidden" id="apply-task-id" name="taskId">
                        
                        <!-- Show login prompt if not logged in -->
                        <div id="apply-login-prompt" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">
                                    <i class="bi bi-info-circle me-2"></i>Account Required
                                </h6>
                                <p class="mb-3">You need to be logged in to apply for tasks. This helps us keep the platform safe and secure.</p>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary" onclick="showLoginModal()">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>Log In
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="showRegisterModal()">
                                        <i class="bi bi-person-plus me-2"></i>Create Account
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Show application form if logged in -->
                        <div id="apply-form-fields">
                            <div class="mb-3">
                                <label for="helper-name" class="form-label">Your Name *</label>
                                <input type="text" class="form-control" id="helper-name" name="helperName" required readonly>
                                <div class="form-text">This will be automatically filled from your account</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="helper-email" class="form-label">Your Email *</label>
                                <input type="email" class="form-control" id="helper-email" name="helperEmail" required readonly>
                                <div class="form-text">This will be automatically filled from your account</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="helper-phone" class="form-label">Phone Number (Optional)</label>
                                <input type="tel" class="form-control" id="helper-phone" name="phone" readonly>
                                <div class="form-text">This will be automatically filled from your account</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="helper-note" class="form-label">Message *</label>
                                <textarea class="form-control" id="helper-note" name="note" rows="3" 
                                    placeholder="Tell the poster about your availability and experience..." required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="meet-requirement" required>
                            <label class="form-check-label" for="meet-requirement">
                                I can meet at the listed time and place *
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Application</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Completion Modal -->
    <div class="modal fade" id="completion-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Task as Completed</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="completion-form">
                    <div class="modal-body">
                        <input type="hidden" id="completion-task-id" name="taskId">
                        
                        <div class="mb-3">
                            <label for="completion-notes" class="form-label">Completion Notes (Optional)</label>
                            <textarea class="form-control" id="completion-notes" name="notes" rows="3" 
                                placeholder="Add any notes about task completion..."></textarea>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="payment-confirmed" name="paymentConfirmed">
                            <label class="form-check-label" for="payment-confirmed">
                                Payment has been confirmed
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Mark as Completed</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-5 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-check-circle-fill text-primary me-2 fs-4"></i>
                        <h5 class="mb-0 fw-bold">GetItDone</h5>
                    </div>
                    <p class="text-white mb-3">Connecting students with tasks that need to be done. A platform built by students, for students.</p>
                    <div class="d-flex gap-3">
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3 text-primary">Platform</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="browse.html" class="text-white text-decoration-none">Browse Tasks</a></li>
                        <li class="mb-2"><a href="post.html" class="text-white text-decoration-none">Post a Task</a></li>
                        <li class="mb-2"><a href="my-stuff.html" class="text-white text-decoration-none">My Stuff</a></li>
                        <li class="mb-2"><a href="account.html" class="text-white text-decoration-none">Account</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3 text-primary">Support</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="rules.html" class="text-white text-decoration-none">Rules & Safety</a></li>
                        <li class="mb-2"><a href="about.html" class="text-white text-decoration-none">About Us</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none">Help Center</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none">Contact Support</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3 text-primary">Legal</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="rules.html#privacy-policy" class="text-white text-decoration-none">Privacy Policy</a></li>
                        <li class="mb-2"><a href="rules.html#terms-of-service" class="text-white text-decoration-none">Terms of Service</a></li>
                        <li class="mb-2"><a href="rules.html#cookie-policy" class="text-white text-decoration-none">Cookie Policy</a></li>
                        <li class="mb-2"><a href="rules.html#community-guidelines" class="text-white text-decoration-none">Community Guidelines</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3 text-primary">Contact</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2 text-white">
                            <i class="bi bi-envelope me-2"></i>
                            <a href="mailto:support@getitdone.com" class="text-white text-decoration-none">support@getitdone.com</a>
                        </li>
                        <li class="mb-2 text-white">
                            <i class="bi bi-telephone me-2"></i>
                            <a href="tel:+15551234567" class="text-white text-decoration-none">(555) 123-4567</a>
                        </li>
                        <li class="mb-2 text-white">
                            <i class="bi bi-geo-alt me-2"></i>
                            <span>University of Alabama<br>Tuscaloosa, AL 35401</span>
                        </li>
                    </ul>
                </div>
            </div>
            <hr class="my-4 border-secondary">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="text-white mb-0">&copy; 2024 GetItDone. All rights reserved. Student project for educational purposes.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-white mb-0">
                        <i class="bi bi-shield-check me-1"></i>
                        Secure & Trusted Platform
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Profile Modal -->
    <div class="modal fade" id="profile-modal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">User Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="profile-modal-content">
                        <!-- Profile content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="startConversationFromProfile()">Message</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div class="modal fade" id="notifications-modal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationsModalLabel">Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="notifications-modal-list">
                        <div class="text-center text-white py-3">No notifications</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="markAllNotificationsRead()">Mark all as read</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div class="modal fade" id="messages-modal" tabindex="-1" aria-labelledby="messagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messagesModalLabel">Messages</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="list-group" id="conversations-list-modal">
                                <div class="text-center text-white py-3">No conversations</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="messages-content" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 id="conversation-title">Select a conversation</h6>
                                </div>
                                <div class="messages-container border rounded p-3 mb-3" style="height: 300px; overflow-y: auto;" id="messages-container-modal">
                                    <div class="text-center text-white">Select a conversation to view messages</div>
                                </div>
                                <form id="message-form-modal">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Type your message..." id="message-input-modal">
                                        <button class="btn btn-primary" type="submit">Send</button>
                                    </div>
                                </form>
                            </div>
                            <div id="no-conversation-selected" class="text-center text-white py-5">
                                <i class="bi bi-chat-dots fs-1"></i>
                                <p>Select a conversation to start messaging</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../assets/scripts/data.js"></script>
    <script src="../assets/scripts/app.js"></script>
    <script>
        // Additional functions for task detail page
        function showApplyModal() {
            const taskId = new URLSearchParams(window.location.search).get('id');
            if (taskId && window.app) {
                window.app.showApplyModal(taskId);
            }
        }

        // Load similar tasks
        function loadSimilarTasks(currentTask) {
            const container = document.getElementById('similar-tasks');
            if (!container) return;

            const allTasks = dataManager.getAllTasks();
            const similarTasks = allTasks
                .filter(task => 
                    task.id !== currentTask.id && 
                    task.status === 'open' &&
                    (task.tags.some(tag => currentTask.tags.includes(tag)) ||
                     task.locationName === currentTask.locationName)
                )
                .slice(0, 3);

            container.innerHTML = '';

            if (similarTasks.length === 0) {
                container.innerHTML = '<p class="text-white">No similar tasks found.</p>';
                return;
            }

            similarTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'border-bottom pb-3 mb-3';
                taskElement.innerHTML = `
                    <h6 class="fw-bold mb-1">${task.title}</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-success fw-bold">$${task.payAmount}</span>
                        <small class="text-white">${task.locationName}</small>
                    </div>
                    <div class="mb-2">
                        ${task.tags.slice(0, 2).map(tag => `<span class="tag-badge">#${tag}</span>`).join('')}
                    </div>
                    <a href="task-detail.html?id=${task.id}" class="btn btn-outline-primary btn-sm">View Details</a>
                `;
                container.appendChild(taskElement);
            });
        }

        // Function to load applications for task poster
        function loadTaskApplicationsForPoster(taskId) {
            const applications = dataManager.getApplicationsByTaskId(taskId);
            const container = document.getElementById('applications-container');

            if (applications.length === 0) {
                container.innerHTML = '<p class="text-muted">No applications yet. Check back later!</p>';
                return;
            }

            container.innerHTML = '';

            applications.forEach(app => {
                const appElement = document.createElement('div');
                appElement.className = 'card mb-3';
                
                const statusClass = `status-${app.status}`;
                const statusText = app.status.charAt(0).toUpperCase() + app.status.slice(1);

                appElement.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="card-title mb-1">${app.helperName}</h6>
                                <p class="card-text text-muted mb-1">
                                    <i class="bi bi-envelope me-1"></i>${app.helperEmail}
                                    ${app.phone ? `<br><i class="bi bi-telephone me-1"></i>${app.phone}` : ''}
                                </p>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge ${statusClass === 'status-submitted' ? 'bg-warning' : statusClass === 'status-accepted' ? 'bg-success' : 'bg-secondary'}">${statusText}</span>
                                ${app.status === 'submitted' ? `
                                    <button class="btn btn-success btn-sm" onclick="approveApplication(${app.id}, ${taskId})">
                                        <i class="bi bi-check me-1"></i>Approve
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="declineApplication(${app.id})">
                                        <i class="bi bi-x me-1"></i>Decline
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="card-text">
                            <strong>Application Note:</strong>
                            <p class="mt-1">${app.note || 'No additional notes provided.'}</p>
                        </div>
                        <div class="text-muted">
                            <small>Applied: ${new Date(app.createdAt).toLocaleDateString()} at ${new Date(app.createdAt).toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;

                container.appendChild(appElement);
            });
        }

        // Function to approve application
        function approveApplication(applicationId, taskId) {
            if (confirm('Are you sure you want to approve this application? This will assign the task to this helper and decline all other applications.')) {
                // Update task status to assigned
                dataManager.updateTask(taskId, { status: 'assigned' });

                // Use acceptApplication method which creates notifications for the helper
                dataManager.acceptApplication(applicationId);

                // Decline all other applications for this task
                const allApplications = dataManager.getApplicationsByTaskId(taskId);
                allApplications.forEach(app => {
                    if (app.id !== applicationId && app.status === 'submitted') {
                        dataManager.rejectApplication(app.id);
                    }
                });

                // Show success message
                if (window.app) {
                    window.app.showSuccess('Application approved! Task assigned to helper.');
                }

                // Reload applications
                loadTaskApplicationsForPoster(taskId);
            }
        }

        // Function to decline application
        function declineApplication(applicationId) {
            if (confirm('Are you sure you want to decline this application?')) {
                // Use rejectApplication method which creates notifications for the helper
                dataManager.rejectApplication(applicationId);
                
                if (window.app) {
                    window.app.showSuccess('Application declined.');
                }

                // Reload applications
                const taskId = new URLSearchParams(window.location.search).get('id');
                loadTaskApplicationsForPoster(taskId);
            }
        }

        // Function to load completion details
        function loadCompletionDetails(task) {
            const completionSection = document.getElementById('completion-details-section');
            if (!completionSection) return;

            // Show the completion details section
            completionSection.style.display = 'block';

            // Populate completion information
            document.getElementById('completion-date').textContent = 
                task.completedAt ? new Date(task.completedAt).toLocaleDateString() : 'Not specified';
            document.getElementById('completion-notes').textContent = 
                task.completionNotes || 'No notes provided';
            
            // Populate payment breakdown
            document.getElementById('total-amount').textContent = `$${task.payAmount.toFixed(2)}`;
            document.getElementById('platform-fee').textContent = `$${task.platformFee.toFixed(2)}`;
            document.getElementById('helper-payment').textContent = `$${task.helperPayment.toFixed(2)}`;
            
            // Show payment method with additional info
            let paymentMethodText = task.paymentMethod === 'online' ? 'Online Payment' : 'Cash Payment';
            if (task.paymentMethod === 'online' && task.onlinePaymentProcessed) {
                paymentMethodText += ` (Card ending in ${task.paymentCardUsed})`;
            } else if (task.paymentMethod === 'cash' && task.cashPaymentCollected) {
                paymentMethodText += ' (Platform fee charged to poster\'s card)';
            }
            document.getElementById('payment-method').textContent = paymentMethodText;
            
            // Update payment status
            const paymentStatus = document.getElementById('payment-status');
            if (task.paymentConfirmed) {
                paymentStatus.textContent = 'Confirmed';
                paymentStatus.className = 'badge bg-success';
            } else {
                paymentStatus.textContent = 'Pending';
                paymentStatus.className = 'badge bg-warning';
            }
        }

        // Function to mark task as completed (for posters)
        function markTaskCompleted() {
            const taskId = new URLSearchParams(window.location.search).get('id');
            if (!taskId) return;

            if (confirm('Are you sure you want to mark this task as completed? This will finalize the task and payment.')) {
                dataManager.updateTask(taskId, { status: 'completed' });
                
                if (window.app) {
                    window.app.showSuccess('Task marked as completed!');
                }

                // Reload the page to show updated status
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        // Enhanced task detail loading
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for app to initialize
            setTimeout(() => {
                const taskId = new URLSearchParams(window.location.search).get('id');
                if (taskId && window.app) {
                    const task = dataManager.getTaskById(taskId);
                    if (task) {
                        loadSimilarTasks(task);
                        
                        // Show completion details if task is completed
                        if (task.status === 'completed') {
                            loadCompletionDetails(task);
                        }
                        
                        // Show applications section if user is the poster
                        const currentUser = window.app.currentUser;
                        if (currentUser && currentUser === task.posterEmail) {
                            document.getElementById('applications-section').style.display = 'block';
                            loadTaskApplicationsForPoster(task.id);
                            
                            // Show completion button if task is assigned
                            const completionButton = document.getElementById('completion-button');
                            if (completionButton && task.status === 'assigned') {
                                completionButton.style.display = 'inline-block';
                            }
                        }
                    }
                }
            }, 200);
        });

        // Add completion form event listener
        document.addEventListener('DOMContentLoaded', () => {
            const completionForm = document.getElementById('completion-form');
            if (completionForm) {
                completionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (window.app) {
                        window.app.handleTaskCompletion(this);
                    }
                });
            }
        });
    </script>
</body>
</html>
